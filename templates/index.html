<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload de Imagem e Vídeo</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4 text-center">Envio de Mídia</h1>
    
    <!-- Formulário de Imagem -->
    <div class="card mb-4">
      <div class="card-header">Envio de Imagem</div>
      <div class="card-body">
        <form id="imageForm">
          <div class="mb-3">
            <input type="file" class="form-control" id="imageInput" accept="image/*" required>
          </div>
          <button type="submit" class="btn btn-primary">Enviar Imagem</button>
        </form>
        <div id="imageStatus" class="mt-3"></div>
        <div id="imageResult" class="mt-3"></div>
      </div>
    </div>

    <!-- Formulário de Vídeo -->
    <div class="card">
      <div class="card-header">Envio de Vídeo</div>
      <div class="card-body">
        <form id="videoForm">
          <div class="mb-3">
            <input type="file" class="form-control" id="videoInput" accept="video/*" required>
          </div>
          <button type="submit" class="btn btn-primary">Enviar Vídeo</button>
        </form>
        <div id="videoStatus" class="mt-3"></div>
        <div id="videoResult" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS (opcional, para componentes interativos) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const socket = io();

    let socketId = null;

    // Recebe o socket_id emitido pelo servidor
    socket.on("connect", () => {
      socketId = socket.id;
      console.log("Conectado com socket_id:", socketId);
    });

    // Evento de resposta de vídeo
    socket.on("video_processed", (data) => {
      const videoStatus = document.getElementById("videoStatus");
      const videoResult = document.getElementById("videoResult");
      videoStatus.innerText = "Vídeo processado com sucesso!";
      if (data.url) {
        videoResult.innerHTML = `<video controls class="w-100 mt-2"><source src="${data.url}" type="video/mp4">Seu navegador não suporta vídeo.</video>`;
      }
    });

    // Manipula envio de imagem
    document.getElementById("imageForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const imageInput = document.getElementById("imageInput");
      const imageStatus = document.getElementById("imageStatus");
      const imageResult = document.getElementById("imageResult");

      if (!imageInput.files[0]) return;

      imageStatus.innerText = "Processando imagem...";
      imageResult.innerHTML = "";

      const formData = new FormData();
      formData.append("image", imageInput.files[0]);

      try {
        const response = await fetch("/processing/image", {
          method: "POST",
          body: formData
        });

        const result = await response.json();

        if (result.url) {
          imageStatus.innerText = "Imagem processada com sucesso!";
          imageResult.innerHTML = `<img src="${result.url}" alt="Imagem processada" class="img-fluid mt-2">`;
        } else {
          imageStatus.innerText = "Erro ao processar imagem.";
        }
      } catch (error) {
        imageStatus.innerText = "Erro na comunicação com o servidor.";
        console.error(error);
      }
    });

    // Manipula envio de vídeo
    document.getElementById("videoForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const videoInput = document.getElementById("videoInput");
      const videoStatus = document.getElementById("videoStatus");
      const videoResult = document.getElementById("videoResult");

      if (!videoInput.files[0] || !socketId) return;

      videoStatus.innerText = "Processando vídeo...";
      videoResult.innerHTML = "";

      const formData = new FormData();
      formData.append("video", videoInput.files[0]);

      try {
        const response = await fetch(`/processing/video?socket_id=${socketId}`, {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          throw new Error("Erro ao enviar vídeo.");
        }
      } catch (error) {
        videoStatus.innerText = "Erro ao enviar vídeo.";
        console.error(error);
      }
    });
  </script>
</body>
</html>
